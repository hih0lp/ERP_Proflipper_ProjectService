image: docker:24.0.7

services:
  - name: docker:24.0.7-dind
    command: ["--tls=false"]

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  DOCKER_REGISTRY: "containerregistry.xn--80aadjammc2a2e.tech"
  IMAGE_TAG: "$DOCKER_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_SHORT_SHA"
  IMAGE_LATEST: "$DOCKER_REGISTRY/$CI_PROJECT_PATH:latest"
  HEALTHCHECK_URL: "http://localhost:${SERVICE_PORT}/health"
  HEALTHCHECK_TIMEOUT: "60"
  IMAGE_ROLLBACK: "$DOCKER_REGISTRY/$CI_PROJECT_PATH:rollback"

stages:
  - build
  - test
  - deploy
  - healthcheck

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –°–¢–ï–ô–î–ñ 1: –°–ë–û–†–ö–ê –û–ë–†–ê–ó–ê
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
build:
  stage: build
  tags:
    - docker
  before_script:
    - echo "$CI_JOB_TOKEN" | docker login -u gitlab-ci-token --password-stdin "$DOCKER_REGISTRY"
  script:
    - echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ $IMAGE_TAG"
    - docker build -t "$IMAGE_TAG" .
    - echo "üì§ –ü—É—à–∏–º –æ–±—Ä–∞–∑ $IMAGE_TAG"
    - docker push "$IMAGE_TAG"
    - echo "üè∑Ô∏è  –¢–µ–≥–∏—Ä—É–µ–º –∫–∞–∫ latest"
    - docker tag "$IMAGE_TAG" "$IMAGE_LATEST"
    - docker push "$IMAGE_LATEST"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –°–¢–ï–ô–î–ñ 2: –¢–ï–°–¢–´
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
dotnet-test-job:
  stage: test
  tags:
    - linux
    - deploy
  image: mcr.microsoft.com/dotnet/sdk:9.0
  script:
    - echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
    - dotnet test --configuration Release --no-build --verbosity normal
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
  allow_failure: false

unit-test-job:
  stage: test
  tags:
    - linux
    - deploy
  script:
    - echo "Code coverage test is not allowed"

lint-test-job:
  stage: test
  tags:
    - linux
    - deploy
  script:
    - echo "No lint tests found."

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –°–¢–ï–ô–î–ñ 3: –î–ï–ü–õ–û–ô
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
deploy:
  stage: deploy
  tags:
    - linux
    - deploy
  script:
    - |
      echo "üöÄ –î–µ–ø–ª–æ–π $SERVICE_NAME –Ω–∞ $DEPLOY_HOST (HOST NETWORK MODE)"
      
      ssh -o StrictHostKeyChecking=yes -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "
        echo 'üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ registry...'
        echo '$CI_REGISTRY_PASSWORD' | docker login -u '$CI_REGISTRY_USER' --password-stdin '$DOCKER_REGISTRY'
        
        echo 'üì• Pull –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞...'
        docker pull '$IMAGE_TAG'
        if docker ps -a --format '{{.Names}}' | grep -q \"^$CONTAINER_NAME\$\"; then
          CURRENT_IMAGE=\$(docker inspect --format='{{.Image}}' \"$CONTAINER_NAME\" 2>/dev/null)
          if [ -n \"\$CURRENT_IMAGE\" ]; then
            echo 'üîñ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –†–ê–ë–û–ß–ò–ô –æ–±—Ä–∞–∑ –∫–∞–∫ $IMAGE_ROLLBACK –¥–ª—è –æ—Ç–∫–∞—Ç–∞'
            docker tag \"\$CURRENT_IMAGE\" \"$IMAGE_ROLLBACK\"
          else
            echo '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±—Ä–∞–∑ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞'
          fi
        else
          echo '‚ÑπÔ∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $CONTAINER_NAME –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ø–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π?)'
        fi
        
        echo '‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä...'
        docker stop '$CONTAINER_NAME' 2>/dev/null || true
        docker rm '$CONTAINER_NAME' 2>/dev/null || true
        
        echo 'üöÄ –ó–∞–ø—É—Å–∫ –ù–û–í–û–ì–û –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ HOST NETWORK MODE...'
        docker run -d \
          --name '$CONTAINER_NAME' \
          --network host \
          --restart unless-stopped \
          -e ASPNETCORE_ENVIRONMENT=Production \
          -e ASPNETCORE_URLS=http://*:$SERVICE_PORT \
          -e DB_HOST='$DB_HOST' \
          -e DB_PORT='$DB_PORT' \
          -e DB_USER='$DB_USER' \
          -e DB_PASSWORD='$DB_PASSWORD' \
          -e JWT_KEY='$JWT_KEY' \
          '$IMAGE_TAG'
        
        echo '‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω! –ü—Ä–æ–≤–µ—Ä–∫–∞:'
        sleep 3
        docker ps --filter name='$CONTAINER_NAME'
        ss -tulpn | grep ':$SERVICE_PORT' || echo '‚è≥ –ü–æ—Ä—Ç –µ—â—ë –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è (—Å—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)...'
        docker logout '$DOCKER_REGISTRY'
      "
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –°–¢–ï–ô–î–ñ 4: HEALTHCHECK
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
healthcheck:
  stage: healthcheck
  tags:
    - linux
    - deploy
  script:
    - |
      echo "ü©∫ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ –ø–æ—Ä—Ç—É $SERVICE_PORT..."
      START_TIME=$(date +%s)
      TIMEOUT=60
      while [ $(( $(date +%s) - START_TIME )) -lt $TIMEOUT ]; do
        if curl -sf --max-time 5 $HEALTHCHECK_URL > /dev/null; then
          echo "‚úÖ Healthcheck —É—Å–ø–µ—à–µ–Ω! –°–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ $HEALTHCHECK_URL"
          exit 0
        fi
        echo "‚è≥ –°–µ—Ä–≤–∏—Å –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤, –∂–¥—ë–º 5 —Å–µ–∫—É–Ω–¥..."
        sleep 5
      done
      echo "‚ùå Healthcheck –ø—Ä–æ–≤–∞–ª–µ–Ω —Å–µ—Ä–≤–∏—Å –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ $TIMEOUT —Å–µ–∫—É–Ω–¥"
      exit 1
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
  allow_failure: true

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –û–¢–ö–ê–¢
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
rollback:
  stage: deploy
  tags:
    - linux
    - deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -p $DEPLOY_PORT $DEPLOY_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      echo "üîÑ –û–¢–ö–ê–¢ $SERVICE_NAME –Ω–∞ –ü–†–ï–î–´–î–£–©–£–Æ –†–ê–ë–û–ß–£–Æ –í–ï–†–°–ò–Æ ($IMAGE_ROLLBACK)..."
      
      ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "
        if ! docker image inspect $IMAGE_ROLLBACK >/dev/null 2>&1; then
          echo '‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –û–±—Ä–∞–∑ $IMAGE_ROLLBACK –Ω–µ –Ω–∞–π–¥–µ–Ω!'
          echo '–í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –ø–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π –∏–ª–∏ –æ–±—Ä–∞–∑ –±—ã–ª —É–¥–∞–ª—ë–Ω.'
          echo '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–µ–ø–ª–æ—è ‚Äî –±—ã–ª –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –æ–±—Ä–∞–∑?'
          exit 1
        fi
        
        echo '‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π (—Å–ª–æ–º–∞–Ω–Ω—ã–π) –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä...'
        docker stop $CONTAINER_NAME 2>/dev/null || true
        docker rm $CONTAINER_NAME 2>/dev/null || true
        
        echo 'üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ü–†–ï–î–´–î–£–©–£–Æ –†–ê–ë–û–ß–£–Æ –í–ï–†–°–ò–Æ –∏–∑ $IMAGE_ROLLBACK...'
        docker run -d \
          --name $CONTAINER_NAME \
          --network host \
          --restart unless-stopped \
          -e ASPNETCORE_ENVIRONMENT=Production \
          -e ASPNETCORE_URLS=http://*:$SERVICE_PORT \
          -e DB_HOST='$DB_HOST' \
          -e DB_PORT='$DB_PORT' \
          -e DB_USER='$DB_USER' \
          -e DB_PASSWORD='$DB_PASSWORD' \
          -e JWT_KEY='$JWT_KEY' \
          $IMAGE_ROLLBACK
        
        echo '‚úÖ –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à—ë–Ω! –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:'
        sleep 3
        docker ps --filter name=$CONTAINER_NAME --format 'table {{.Names}}\t{{.Status}}'
        echo 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞:'
        ss -tulpn | grep ':$SERVICE_PORT' || echo '‚ö†Ô∏è –ü–æ—Ä—Ç –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è'
      "
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_failure
  when: manual
  allow_failure: true